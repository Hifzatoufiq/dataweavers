<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Anomaly Detection Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0/dist/chartjs-adapter-luxon.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<style>
    body {
        background: linear-gradient(-45deg, #3b82f6, #1e3a8a, #f59e0b, #8b5cf6);
        background-size: 400% 400%;
        animation: gradientBG 15s ease infinite;
        transition: background 0.5s;
    }
    @keyframes gradientBG {
        0% {background-position: 0% 50%;}
        50% {background-position: 100% 50%;}
        100% {background-position: 0% 50%;}
    }

    nav {
        background-size: 200% 200%;
        animation: navGradient 10s linear infinite;
        transition: background 0.5s;
    }
    @keyframes navGradient {
        0% {background-position: 0% 50%;}
        50% {background-position: 100% 50%;}
        100% {background-position: 0% 50%;}
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 25px rgba(0,0,0,0.2);
    }
</style>
</head>
<body class="text-gray-800 font-sans transition-colors duration-500">

<div class="flex h-screen">



    <!-- Main Content -->
    <div class="flex-1 flex flex-col">

        <!-- Navbar -->
        <nav class="bg-gradient-to-r from-blue-700 to-blue-500 text-white shadow-lg flex justify-between items-center px-6 py-4">
            <h1 class="text-2xl font-bold tracking-wide">StockPulse </h1>
            <button id="theme-toggle" class="bg-white text-blue-700 px-4 py-1 rounded hover:bg-gray-200 transition shadow">Toggle Theme</button>
        </nav>

        <!-- Content -->
        <main class="flex-1 overflow-auto p-6 space-y-6 bg-gray-100">

            <!-- Controls -->
            <div class="bg-white shadow rounded-xl p-6 card transition duration-300">
                <h2 class="text-xl font-semibold mb-4 text-gray-700">Select Date Range</h2>
                <div class="flex flex-col md:flex-row gap-6 items-end">
                    <div class="flex-1">
                        <label for="start-date" class="block font-medium mb-1 text-gray-600">Start Date</label>
                        <input type="date" id="start-date" class="w-full border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="flex-1">
                        <label for="end-date" class="block font-medium mb-1 text-gray-600">End Date</label>
                        <input type="date" id="end-date" class="w-full border-gray-300 rounded-lg px-3 py-2 shadow-sm focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <button id="detect-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow-md transition duration-300">Detect Anomalies</button>
                    </div>
                </div>
                <p id="error-message" class="text-red-600 mt-3 hidden"></p>
            </div>

            <style>
.can{
    width: 800px;
    margin: auto
}
            </style>

            <!-- Graph centered -->
            <div class="can bg-white shadow rounded-xl p-6 relative h-96 card transition duration-300">
                <canvas class="canva" id="stock-chart" class="h-full"></canvas>
                <div id="loader" class="absolute inset-0 flex justify-center items-center bg-white/60 hidden">
                    <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                </div>
            </div>

            <!-- KPI Cards -->
            <div class="grid md:grid-cols-3 gap-6">
                <div class="bg-white shadow rounded-xl p-6 card transition duration-300">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Z-Score Anomalies</h3>
                    <p class="text-sm text-gray-500 mb-4">Standard deviation based anomalies</p>
                    <div class="flex justify-between mt-4">
                        <div class="text-center">
                            <div id="zscore-count" class="text-2xl font-bold text-gray-800">0</div>
                            <div class="text-gray-500 text-sm">Detected</div>
                        </div>
                        <div class="text-center">
                            <div id="zscore-percent" class="text-2xl font-bold text-gray-800">0%</div>
                            <div class="text-gray-500 text-sm">of total data</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow rounded-xl p-6 card transition duration-300">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Isolation Forest</h3>
                    <p class="text-sm text-gray-500 mb-4">Tree-based anomaly detection</p>
                    <div class="flex justify-between mt-4">
                        <div class="text-center">
                            <div id="iforest-count" class="text-2xl font-bold text-gray-800">0</div>
                            <div class="text-gray-500 text-sm">Detected</div>
                        </div>
                        <div class="text-center">
                            <div id="iforest-percent" class="text-2xl font-bold text-gray-800">0%</div>
                            <div class="text-gray-500 text-sm">of total data</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white shadow rounded-xl p-6 card transition duration-300">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">DBSCAN Clustering</h3>
                    <p class="text-sm text-gray-500 mb-4">Density-based anomaly detection</p>
                    <div class="flex justify-between mt-4">
                        <div class="text-center">
                            <div id="dbscan-count" class="text-2xl font-bold text-gray-800">0</div>
                            <div class="text-gray-500 text-sm">Detected</div>
                        </div>
                        <div class="text-center">
                            <div id="dbscan-percent" class="text-2xl font-bold text-gray-800">0%</div>
                            <div class="text-gray-500 text-sm">of total data</div>
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- Footer -->
        <footer class="bg-gray-200 text-gray-600 py-4 text-center transition-colors duration-500">
            &copy; 2023 Stock Anomaly Detection. Powered by Flask & TailwindCSS.
        </footer>

    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const startDateInput = document.getElementById('start-date');
    const endDateInput = document.getElementById('end-date');
    const detectBtn = document.getElementById('detect-btn');
    const loader = document.getElementById('loader');
    const errorMessage = document.getElementById('error-message');
    const ctx = document.getElementById('stock-chart').getContext('2d');
    let chart = null;

    const themeToggle = document.getElementById('theme-toggle');
    themeToggle.addEventListener('click', () => {
        document.body.classList.toggle('bg-gray-900');
        document.body.classList.toggle('text-white');
        document.querySelector('footer').classList.toggle('bg-gray-800');
        document.querySelector('footer').classList.toggle('text-gray-200');
    });

    detectBtn.addEventListener('click', function() {
        const startDate = startDateInput.value;
        const endDate = endDateInput.value;
        if (!startDate || !endDate) { showError("Please select both start and end dates"); return; }
        if (startDate > endDate) { showError("Start date cannot be after end date"); return; }
        detectAnomalies(startDate, endDate);
    });

    function detectAnomalies(startDate, endDate) {
        loader.classList.remove('hidden');
        errorMessage.classList.add('hidden');
        fetch('/api/anomalies', {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ start_date:startDate, end_date:endDate })
        }).then(r=>r.json()).then(data=>{
            loader.classList.add('hidden');
            if(data.error){showError(data.error); return;}
            updateStats('zscore', data.zscore_anomalies);
            updateStats('iforest', data.iforest_anomalies);
            updateStats('dbscan', data.dbscan_anomalies);
            drawChart(data);
        }).catch(err=>{
            loader.classList.add('hidden');
            showError("Error fetching data");
        });
    }

    function updateStats(type, anomalies){
        const count = anomalies.filter(x=>x===1).length;
        const percent = ((count/anomalies.length)*100).toFixed(1);
        document.getElementById(`${type}-count`).textContent = count;
        document.getElementById(`${type}-percent`).textContent = percent+"%";
    }

    function drawChart(data){
        const dates = data.dates;
        const close = data.close;
        const upper = data.upper_bb;
        const lower = data.lower_bb;
        const zscoreAnomalies = data.zscore_anomalies.map((v,i)=>v===1?{x:dates[i],y:close[i]}:null).filter(v=>v);
        const iforestAnomalies = data.iforest_anomalies.map((v,i)=>v===1?{x:dates[i],y:close[i]}:null).filter(v=>v);
        const dbscanAnomalies = data.dbscan_anomalies.map((v,i)=>v===1?{x:dates[i],y:close[i]}:null).filter(v=>v);

        const datasets=[
            {label:'Close Price', data:close.map((v,i)=>({x:dates[i],y:v})), borderColor:'#1E3A8A', fill:false},
            {label:'Upper BB', data:upper.map((v,i)=>({x:dates[i],y:v})), borderColor:'#3B82F6', borderDash:[5,5], fill:false},
            {label:'Lower BB', data:lower.map((v,i)=>({x:dates[i],y:v})), borderColor:'#3B82F6', borderDash:[5,5], fill:false},
            {label:'Z-Score', data:zscoreAnomalies, backgroundColor:'#EF4444', pointRadius:5, type:'scatter'},
            {label:'IsolationForest', data:iforestAnomalies, backgroundColor:'#F59E0B', pointRadius:5, type:'scatter'},
            {label:'DBSCAN', data:dbscanAnomalies, backgroundColor:'#8B5CF6', pointRadius:5, type:'scatter'},
        ];

        if(chart){ chart.data.datasets=datasets; chart.update(); }
        else{
            chart=new Chart(ctx,{
                type:'line',
                data:{datasets},
                options:{
                    responsive:true,
                    interaction:{mode:'nearest', intersect:false},
                    scales:{ x:{ type:'time', time:{unit:'month'} }, y:{ title:{display:true,text:'Price'} } }
                }
            });
        }
    }

    function showError(msg){ errorMessage.textContent=msg; errorMessage.classList.remove('hidden'); }

    const today=new Date(); const past=new Date(); past.setFullYear(today.getFullYear()-3);
    startDateInput.value=past.toISOString().slice(0,10); endDateInput.value=today.toISOString().slice(0,10);
    detectBtn.click();
});
</script>
</body>
</html>
